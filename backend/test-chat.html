<!DOCTYPE html>
<html>
<head>
    <title>LearnSync èŠå¤©æµ‹è¯•</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Microsoft YaHei', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 20px;
            text-align: center;
        }
        .header h1 {
            margin-bottom: 5px;
            font-size: 24px;
        }
        .online-users {
            background: #f8f9fa;
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .online-users .count {
            background: #4CAF50;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
        }
        .chat-box {
            height: 400px;
            overflow-y: auto;
            padding: 20px;
            background: #fafafa;
        }
        .message {
            margin: 10px 0;
            padding: 12px;
            border-radius: 10px;
            max-width: 80%;
            animation: fadeIn 0.3s ease-in;
        }
        .message.user {
            background: #e3f2fd;
            margin-left: auto;
            border-bottom-right-radius: 2px;
        }
        .message.other {
            background: #f5f5f5;
            margin-right: auto;
            border-bottom-left-radius: 2px;
        }
        .message.system {
            background: #fff3cd;
            margin: 10px auto;
            text-align: center;
            max-width: 60%;
            font-style: italic;
        }
        .message .sender {
            font-weight: bold;
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }
        .message .time {
            font-size: 10px;
            color: #999;
            float: right;
            margin-left: 10px;
        }
        .input-area {
            padding: 20px;
            background: white;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 10px;
        }
        .input-area input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            outline: none;
            font-size: 14px;
        }
        .input-area input:focus {
            border-color: #4CAF50;
        }
        .input-area button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        .input-area button:hover {
            background: #45a049;
        }
        .user-list {
            background: #e8f5e8;
            padding: 10px 15px;
            border-radius: 10px;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ’¬ LearnSync å®æ—¶èŠå¤©ç³»ç»Ÿ</h1>
            <p>æˆå‘˜C - å®æ—¶åä½œåŠŸèƒ½æ¼”ç¤º</p>
        </div>
        
        <div class="online-users">
            <div class="user-list">
                ğŸŸ¢ åœ¨çº¿ç”¨æˆ·: <span id="onlineCount">0</span> äºº
                <span id="userNames">æš‚æ— ç”¨æˆ·</span>
            </div>
            <div>
                <span class="count">æ¶ˆæ¯æ•°: <span id="messageCount">0</span></span>
            </div>
        </div>
        
        <div class="chat-box" id="chatBox">
            <div class="message system">
                æ¬¢è¿ä½¿ç”¨ LearnSync èŠå¤©ç³»ç»Ÿï¼è¯·å…ˆè®¾ç½®ä½ çš„ç”¨æˆ·åã€‚
            </div>
        </div>
        
        <div class="input-area">
            <input type="text" id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯... æŒ‰å›è½¦å‘é€">
            <button onclick="sendMessage()">å‘é€</button>
            <button onclick="setUsername()" style="background: #ff9800;">è®¾ç½®åå­—</button>
        </div>
    </div>

    <script>
        // è¿æ¥æœåŠ¡å™¨
        const socket = io('http://localhost:3000');
        let username = 'ç”¨æˆ·' + Math.floor(Math.random() * 1000);
        let isJoined = false;

        // è¿æ¥æˆåŠŸ
        socket.on('connect', () => {
            console.log('âœ… è¿æ¥æœåŠ¡å™¨æˆåŠŸ');
            addSystemMessage('å·²è¿æ¥åˆ°æœåŠ¡å™¨');
        });

        // æ¥æ”¶æ–°æ¶ˆæ¯
socket.on('new-message', (message) => {
    console.log('ğŸ“¥ æ”¶åˆ°æ–°æ¶ˆæ¯:', message);
    addMessageToChat(message);
    updateMessageCount();
});
        

        // æ›´æ–°åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
        socket.on('online-users-update', (users) => {
            document.getElementById('onlineCount').textContent = users.length;
            document.getElementById('userNames').textContent = users.map(u => u.username).join(', ');
        });

        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©æ¡†
        function addMessageToChat(message) {
            const chatBox = document.getElementById('chatBox');
            const messageDiv = document.createElement('div');
            
            messageDiv.className = `message ${message.type === 'system' ? 'system' : 
                                  message.sender === username ? 'user' : 'other'}`;
            
            messageDiv.innerHTML = `
                <div class="sender">${message.sender}</div>
                <div>${message.content}</div>
                <div class="time">${message.time}</div>
            `;
            
            chatBox.appendChild(messageDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
        function addSystemMessage(content) {
            const chatBox = document.getElementById('chatBox');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message system';
            messageDiv.textContent = content;
            chatBox.appendChild(messageDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // å‘é€æ¶ˆæ¯
function sendMessage() {
    const input = document.getElementById('messageInput');
    const content = input.value.trim();
    
    console.log('ğŸ” ç‚¹å‡»å‘é€æŒ‰é’®ï¼Œå†…å®¹:', content);
    console.log('ğŸ” ç”¨æˆ·ç™»å½•çŠ¶æ€:', isJoined);
    console.log('ğŸ” å½“å‰ç”¨æˆ·å:', username);
    
    if (!isJoined) {
        console.log('âŒ ç”¨æˆ·æœªåŠ å…¥èŠå¤©');
        addSystemMessage('è¯·å…ˆè®¾ç½®ç”¨æˆ·åï¼');
        setUsername();
        return;
    }
    
    if (content) {
        console.log('ğŸ“¤ å‡†å¤‡å‘é€æ¶ˆæ¯:', {
            content: content,
            username: username
        });
        
        socket.emit('send-message', { 
            content: content
        });
        
        console.log('âœ… æ¶ˆæ¯å·²å‘é€åˆ°æœåŠ¡å™¨');
        input.value = '';
    } else {
        console.log('âŒ æ¶ˆæ¯å†…å®¹ä¸ºç©º');
    }
}

        // è®¾ç½®ç”¨æˆ·å
        function setUsername() {
            const newName = prompt('è¯·è¾“å…¥ä½ çš„ç”¨æˆ·å:', username);
            if (newName && newName.trim()) {
                username = newName.trim();
                socket.emit('join-chat', { 
                    username: username,
                    userId: Date.now()
                });
                isJoined = true;
                addSystemMessage(`ä½ å¥½ ${username}ï¼å¼€å§‹èŠå¤©å§ï¼`);
            }
        }

        // æ›´æ–°æ¶ˆæ¯è®¡æ•°
        function updateMessageCount() {
            const count = document.querySelectorAll('.message').length - 1;
            document.getElementById('messageCount').textContent = count;
        }

        // å›è½¦å‘é€æ¶ˆæ¯
        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        // è‡ªåŠ¨è®¾ç½®ç”¨æˆ·å
        setTimeout(setUsername, 1000);
    </script>
</body>
</html>